*******
NOTES
*******

cat("\014")
gc()
# *******************************************************************************
# 

url_css <- "http://www.css.gob.pa/transparencia.html"
# Start, active splash ----
splash("localhost") %>% splash_active()

# Open a pdf file
file_name <- paste0("./00_data/images/css_", "dic",".png")
a <- render_png(url = url_css, wait = 5)
image_write(a, file_name)

png() 
splash("localhost") %>% splash_active()
# Close the pdf file
dev.off() 




# load and format external data
if(requiere_joins_files) {
	# meduca 
	meduca_tbl <- readr::read_csv(paste0(PATH_OUT, "meduca_nov.csv"))
	meduca_tbl[c(20300, 20861, 31126, 38777, 42841), ] 
	meduca_tbl[c(20300, 20861, 38777), c("GASTOS")] <- 1000
	meduca_tbl[c(31126), c("GASTOS")] <- 3000
	meduca_tbl[c(42841), c("GASTOS")] <- 3500
	meduca_tbl[c(20300, 20861, 31126, 38777, 42841), ] 
	meduca_tbl[meduca_tbl$CEDULA == "8-0252-00598", c("GASTOS")] <- 3000
	meduca_tbl[meduca_tbl$CEDULA == "1-0015-00887", c("GASTOS")] <- 1000
	meduca_tbl[meduca_tbl$CEDULA == "8-0163-01149", c("GASTOS")] <- 1000
	meduca_tbl[meduca_tbl$CEDULA == "8-0195-00824", c("GASTOS")] <- 3000
	meduca_tbl[is.na(meduca_tbl$`FECHA DE INICIO`) == TRUE, 8] <- "01/12/2019"
	
	meduca_tbl <- meduca_tbl %>% 
		clean_names()
	
	meduca_tbl %>% 
		glimpse()
	
	meduca_tbl <- meduca_tbl %>% 
		mutate(
			codigo = "007",
			entidad = "Ministerio de Educación",
			url = "http://www.contraloria.gob.pa/archivos_planillagub/Index_planillagub3.asp",
			status = "-1", 
			salario = as.character(salario),
			gastos = as.character(gastos)
		) %>% 
		rename(
			nombre = nombres, 
			gasto = gastos, 
			fecha_inicio = fecha_de_inicio
		) %>% 
		select(codigo, entidad, url, status, nombre, apellido, cedula, cargo, salario, gasto, estado, fecha_inicio)
	
	final_tbl <- final_tbl %>% 
		filter(!(codigo == "007")) # borra a meduca 
	final_tbl <- rbind(final_tbl, meduca_tbl) # agrega meduca 
	
	# CSS 
	css_tbl <- readr::read_csv(paste0(PATH_OUT, "css_employees_processing.csv"))
	css_tbl <- css_tbl %>% 
		clean_names()
	
	css_tbl <- css_tbl %>% 
		mutate(
			x1 = NULL,
			person_id = map_chr(person_id, get_people_id), # standarize "cedula"
			codigo = "900",
			entidad = "Caja de Seguro Social",
			nombre =  map2_chr(complete_name, 1, get_split_value), # str_split(complete_name, pattern = " ")[[1]][1],
			apellido = map2_chr(complete_name, 2, get_split_value), # str_split(complete_name, pattern = " ")[[1]][2],
			entity = as.character(entity),
			salary = as.character(salary),
			expens = as.character(expens),
			over_costs = as.character(over_costs), 
			total = as.character(total),
			start_date = as.character(start_date)
		) %>% 
		rename(
			url = site, 
			cedula = person_id,
			cargo = job_title, 
			salario = salary, 
			gasto = expens, 
			fecha_inicio = start_date,
			estado = status
		) %>% 
		mutate(status = "-1") %>% 
		select(codigo, entidad, url, status, nombre, apellido, cedula, cargo, salario, gasto, estado, fecha_inicio, departament, over_costs)
	
	css_tbl %>% 
		glimpse()
	final_tbl$departament = "unknow"
	final_tbl$over_costs = "0"
	
	# procesar formato de cédula
	#key <- "10-21-450"
	#key <- "8-0925-00290"
	
	final_tbl <- rbind(final_tbl, css_tbl)
}







semilla. gwag / gwagwa.
Ibler / Ibeler | Olowaibibbiler. personaje central en babigala, simboliza
la liberación de la madre tierra; el bien.
aprender. durdagged.
estrella. nisgwa.
informar. owisoged.
binoed / binoged / obinoed / obinoged. renovar, innovar, remozar; reorganizar.
organizar. ilemagged.


ad valorem 
Expresión latina que significa 'según el valor'; se aplica a los derechos y tasas que se basan en el valor de un producto.


word trade wiki 
Trade Statistics

Gwag 
data analitcs platform 

ad valorem 
data analitcs platform 

Ibler
data analitcs platform 


iFrame tableau
<iframe frameborder="0" marginheight="0" marginwidth="0" title="Visualización de datos" allowtransparency="true" allowfullscreen="true" class="tableauViz" style="display: block; width: 380px; height: 1250px; margin: 0px; padding: 0px; border: none;" src="http://public.tableau.com/views/migrantes7/Movil2?:embed=y&amp;:showVizHome=no&amp;:host_url=https%3A%2F%2Fpublic.tableau.com%2F&amp;:embed_code_version=3&amp;:tabs=no&amp;:toolbar=yes&amp;:animate_transition=yes&amp;:display_static_image=no&amp;:display_spinner=no&amp;:display_overlay=yes&amp;:display_count=yes&amp;publish=yes&amp;:loadOrderID=1"></iframe>












registro_tbl <- readr::read_csv("./00_data/out/salaries/pending_process/2020/april/central_gov_salaries_april.csv")

registro_tbl <- registro_tbl %>% 
	group_by(entity) %>% 
	summarise(count = n(), total = sum(total_income)/1000000) %>% 
	arrange(desc(total))

sum(registro_tbl$total)

write.csv(registro_tbl, "./00_data/out_registro.csv")


temp_tbl <- as_tibble(query_results) %>% 
	filter(entity == 'Caja de Seguro Social') %>% 
	arrange(desc(total))

sum(temp_tbl$total) # 26,206

temp_tbl <- temp_tbl %>% 
	mutate(
		position_modified =  stringr::str_replace(position, " ", "_"), 
		position_modified =  ifelse(position_modified == 'ALBAÃÂIL_JEFE', 'ALBANIL_JEFE', position_modified),
		position_modified =  ifelse(position_modified == 'TECNOLOGO_EN RADIOLOG E IMÃ\u0083Â\u0081GENES I II', "TECNOLOGO_EN RADIOLOG E IMAGENES I II",position_modified),
		position_modified =  ifelse(position_modified == 'CORREDOR_DE PRIMA DE ANTIGÃ\u0083Â\u009cEDAD', "CORREDOR_DE PRIMA DE ANTIGUEDAD",position_modified),
		date = as.Date("2020-02-01", tryFormats = c('%Y-%m-%d'))
	) %>% 
	dplyr::select(entity, position, position_modified, date, total, salary)
	
# 1: Load principal table: staging_central_gov_salaries
tryCatch(
	{
		job <- insert_upload_job("rowsums", "data_test", table = "staging_jobs_diferences", 
														 values = temp_tbl, write_disposition = "WRITE_TRUNCATE")
		status <- wait_for(job)
	}, # end try
	error=function(error_message) {
		print(error_message)
	}) 

Autoridad de Turismo Panamá *
	http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=24
2020-05-13 02:49:02

Autoridad Panameña de Seguridad de Alimentos
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&id=165
2020-05-14 11:05:27

Defensoría del Pueblo
2020-04-29 01:34:46
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=54





Autoridad de Protección al Consumidor
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=22
2020-03-02 06:23:46

Autoridad Nacional de los Servicios Públicos
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=33
2020-03-10 05:08:56

Dirección General de Contrataciones Públicas
2020-03-13 01:37:36
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=56




Autoridad Nacional para la Innovación Gubernamental
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&id=162
2017-02-09 04:51:00




Fiscalía de Cuentas
2020-01-22 11:17:06
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=58


Lotería Nacional de Beneficencia
2020-01-10 05:00:11
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=82






CSS
2020-02-20 01:29:45
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=43


ACP 
http://ogov.defensoria.gob.pa/transparencia/index.php?option=com_k2&view=item&layout=item&id=26
2020-02-21 09:55:47


Precios de paridad nacional
http://www.energia.gob.pa/energia/wp-content/uploads/sites/2/2020/05/Precio-de-paridad-Precios-Históricos-20mayo2020.pdf









# *************************************
# more data
PATH_IN <- "./00_data/"

# salary data
education_tbl <- readr::read_csv(paste0(PATH_IN, "people_grade.csv")) 
education_tbl$X1 <- NULL 

education_tbl <- education_tbl %>% 
	rename(codigo_2010 = codigo) %>% 
	spread(key = grade, value = total)
education_tbl[is.na(education_tbl)] <- 0
education_tbl <- education_tbl %>% 
	janitor::clean_names()

panama_map_geojson@data <- left_join(panama_map_geojson@data, education_tbl, by = 'codigo_2010')
panama_map_geojson@data %>% 
	DataExplorer::plot_missing()

# *************************************
# more data
PATH_IN <- "./00_data/"

# salary data
home_salary_tbl <- readr::read_csv(paste0(PATH_IN, "home_salary_tbl.csv")) 
home_salary_tbl$X1 <- NULL 

home_salary_tbl <- home_salary_tbl %>% 
	rename(codigo_2010 = codigo) %>% 
	spread(key = rango_salarial, value = hogares)
home_salary_tbl[is.na(home_salary_tbl)] <- 0

panama_map_geojson@data <- left_join(panama_map_geojson@data, home_salary_tbl, by = 'codigo_2010')
panama_map_geojson@data %>% 
	DataExplorer::plot_missing()


# education data
people_age_tbl <- readr::read_csv(paste0(PATH_IN, "people_age.csv"))
people_age_tbl$X1 <- NULL 
people_age_tbl %>% 
	count(age_group_1)
sum(people_age_tbl$total)


menos_25 <- c('0-4', '5-9', '10-14', '15-19', '20-24')
x25_45 <-   c('25-29', '30-34', '35-39', '40-44')
x45_65 <-   c('45-49', '50-54', '55-59', '60-64')

people_age_tbl <- people_age_tbl %>% 
	rename(codigo_2010 = codigo) %>% 
	mutate(
		age_group = 'mas_65',
		age_group = ifelse(age_group_1 %in% c(menos_25), 'menos_25',  age_group),
		age_group = ifelse(age_group_1 %in% c(x25_45), 'x25_45',  age_group),
		age_group = ifelse(age_group_1 %in% c(x45_65), 'x45_65',  age_group)
		) %>% 
	dplyr::select(codigo_2010, age_group, total) %>% 
	group_by(codigo_2010, age_group) %>% 
	summarise(total =sum(total)) %>% 
	ungroup() %>% 
	spread(key = age_group, value = total) %>% 
	mutate(poblacion = menos_25 + x25_45 + x45_65 + mas_65)

people_age_tbl
(251541 + 1571293 +989183 +593796) - 3405813

